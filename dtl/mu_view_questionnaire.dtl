<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="static/css/style.css">
  <script src="static/js/vue.js"></script>
  <script src="static/js/utility.js"></script>
  <body>
    {% verbatim %}
    <div class = "container">
      <section id="question">
        Progress bar: <progress :max="max_score" :value="score"></progress>
        <p> Pid: {{pid}} </p>
        <p> Tip odgovora/strani: {{question.answers_type}} </p>
        <p v-if="scoring==1"> Score: {{score}} </p>
        <p> Vprašanje: {{question.id}} </p>
        <h3>{{question.question}}</h3>
        <div v-if="typeof question['image'] != 'undefined' && question['image'] != '' ">
            <img :src="encodeURI(question.folder + question.image)" :alt="question.image" class="img-fluid">
        </div>
        <section>
          <form v-if="question.answers_type == 'selectOne'">
            <p v-for="(answer, index) in question.answers">
              <label class="radio-inline">
                <input type="radio" :value="index+1" v-model="answerId">{{answer.value}}
              </label>
            </p>
          </form>
        </section>
        <button style="margin-top:10px;" v-on:click="nextQuestion()">Naprej</button>
      </section>

    </div>
    {% endverbatim %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script>
    questionnaireId = {{ questionnaireId }};

    function alertj(obj) {
      alert(JSON.stringify(obj))
    }
    new Vue({
      el: '#question',
      data: {
        question: "",
        pid: 0,
        score: 0,
        answerId: 0,
        scoring : {{scoring}},
        max_score : {{max_score}},
        image: "test.jpg"
      },
      mounted: function() {
          var userdata = JSON.stringify({
            "child": "new"
          }); self=this
          $.post("/api/questionnaire", userdata, function(data) {
            if(data.error) alert(data.error);
            else {
              self.pid=data; self.nextQuestion()
            }
          })
      },
      methods: {
        alertj: function(obj) {
          alert(JSON.stringify(obj))
        },
        nextQuestion: function() {
          var data = JSON.stringify({
            "question": "next",
            "questionnaireId": questionnaireId,
            "questionId": this.question.id,
            "answerId": this.question.answers_type=="motivation"?-1:this.answerId,
            "pid" : this.pid,
            "scoring" : this.scoring
          });
          self=this
          $.post("/api/questionnaire", data, function(data) {
            if(data.error) alert(data.error);
            else {
              if(data.question=="") {
                alert("Vprašalnik končan!")
                window.history.replaceState(null, "test", location.protocol + '//' + location.host + "/")
                window.location.href = "/questionnaires"
              }
              else {
                try {
                  if(data.question.answers != "undefined") {
                    data.question.answers = JSON.parse(data.question.answers)
                    self.answerId = 0
                  }
                  else {
                    data.question["answers"] = []
                    self.answerId = -1 // if we send 0 to server, server would return same question, if -1 server returns nextdefault question
                  }
                  self.question=data.question
                  self.score=data.score
                } catch(ex) {
                  alert("Napaka: "+data.question.answers)
                }
              }
            }
          })
        }
      }
    })
    </script>
  </body>

</html>
